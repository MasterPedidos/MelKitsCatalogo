/* ============================================================
   PROMO√á√ÉO PROGRESSIVA MELKITS  (CONFIG + FUN√á√ïES AUXILIARES)
   ------------------------------------------------------------
   - Contagem por soma TOTAL de caixas do pedido (B)
   - At√© 4 n√≠veis de b√¥nus
   - B√¥nus entra no carrinho e no WhatsApp com valor 0,00
   - Sempre vale APENAS o n√≠vel mais alto atingido
   ============================================================ */

const PROMO_PROGRESSIVA_ATIVA = true;

/* 
   N√≠veis da promo√ß√£o:
   - minQtd  = quantidade TOTAL de caixas no pedido
   - codBrinde = c√≥digo do produto brinde (j√° existente no produtos.json)
   - texto   = texto para tela explicativa
   ‚ûú AJUSTAR ESSES VALORES CONFORME SUA CAMPANHA
*/
const PROMO_NIVEIS = [
  { minQtd: 10, codBrinde: "9001", texto: "Compre 10 caixas ‚Üí Ganhe Produto X" },
  { minQtd: 20, codBrinde: "9002", texto: "Compre 20 caixas ‚Üí Ganhe Produto Y" },
  { minQtd: 30, codBrinde: "9003", texto: "Compre 30 caixas ‚Üí Ganhe Produto Z" },
  { minQtd: 40, codBrinde: "9004", texto: "Compre 40 caixas ‚Üí Ganhe Super Produto" }
];

/* 
   Guarda o c√≥digo do brinde atualmente aplicado no carrinho.
   null = nenhum n√≠vel alcan√ßado / sem brinde.
*/
let codigoBrindeAtual = null;

/* Soma total de caixas eleg√≠veis (N√ÉO soma brindes) */
function calcularTotalQtdElegivel() {
  let soma = 0;
  for (const cod in carrinho) {
    const item = carrinho[cod];
    if (!item) continue;
    if (item.brinde) continue; // n√£o conta brinde
    soma += Number(item.qtd) || 0;
  }
  return soma;
}

/* Descobre o n√≠vel mais alto atingido dado o total de caixas */
function descobrirNivelBrinde(totalQtd) {
  if (!PROMO_PROGRESSIVA_ATIVA || !Array.isArray(PROMO_NIVEIS)) return null;
  let nivel = null;
  PROMO_NIVEIS.forEach(n => {
    if (totalQtd >= n.minQtd) {
      if (!nivel || n.minQtd > nivel.minQtd) {
        nivel = n;
      }
    }
  });
  return nivel;
}

/* Aplica / troca / remove brinde automaticamente conforme o total de caixas */
function aplicarBrindeSeNecessario() {
  if (!PROMO_PROGRESSIVA_ATIVA || !PROMO_NIVEIS.length) return;

  const totalQtd = calcularTotalQtdElegivel();
  const nivel = descobrirNivelBrinde(totalQtd);

  // Se n√£o tem mais n√≠vel v√°lido, remove qualquer brinde
  if (!nivel) {
    if (codigoBrindeAtual && carrinho[codigoBrindeAtual]) {
      delete carrinho[codigoBrindeAtual];
    }
    codigoBrindeAtual = null;
    return;
  }

  // Se j√° est√° o mesmo brinde, s√≥ garante consist√™ncia
  if (codigoBrindeAtual === nivel.codBrinde && carrinho[codigoBrindeAtual]) {
    carrinho[codigoBrindeAtual].qtd = 1;
    carrinho[codigoBrindeAtual].valor = 0;
    carrinho[codigoBrindeAtual].brinde = true;
    carrinho[codigoBrindeAtual].nivelBrinde = nivel.minQtd;
    return;
  }

  // Trocou de n√≠vel ‚Üí remove brinde anterior, se existir
  if (codigoBrindeAtual && codigoBrindeAtual !== nivel.codBrinde && carrinho[codigoBrindeAtual]) {
    delete carrinho[codigoBrindeAtual];
  }

  // Procura o produto brinde no cat√°logo
  const prodBrinde = produtos.find(p => String(p.codigo).trim() === String(nivel.codBrinde).trim());
  if (!prodBrinde) {
    // Se n√£o achar o produto de brinde, s√≥ n√£o aplica nada
    codigoBrindeAtual = null;
    return;
  }

  // Adiciona brinde com valor 0,00
  carrinho[nivel.codBrinde] = {
    ...prodBrinde,
    qtd: 1,
    valor: 0,
    unidades: Number(prodBrinde.unidades) || 1,
    brinde: true,
    nivelBrinde: nivel.minQtd
  };

  codigoBrindeAtual = nivel.codBrinde;
}

/* Texto explicativo da promo√ß√£o progressiva (para mostrar em tela) */
function montarTextoPromoProgressiva() {
  if (!PROMO_PROGRESSIVA_ATIVA || !PROMO_NIVEIS.length) return "";
  let linhas = ["üéÅ Promo√ß√£o Progressiva MelKits"];
  PROMO_NIVEIS.forEach(n => {
    linhas.push(n.texto);
  });
  return linhas.join("<br>");
}

/* ============================================================
   FIM BLOCO PROMO√á√ÉO PROGRESSIVA MELKITS
   ============================================================ */
/* --- MOSTRAR PRODUTOS DE UMA MARCA --- */
function mostrarProdutos(marca) {

  if (!produtosCarregados) {
    alert("Produtos ainda carregando, tente novamente.");
    return;
  }

  document.getElementById("tela-marcas").classList.add("hidden");
  document.getElementById("tela-carrinho").classList.add("hidden");
  document.getElementById("tela-produtos").classList.remove("hidden");
  document.getElementById("btnCarrinho").style.display = "inline-block";
  document.getElementById("btnEnviarPedido").style.display = "none";

  const container = document.getElementById("produtos-container");
  container.innerHTML = "";
  document.getElementById("titulo-marca").textContent = marca;

  let lista = [];

  if (marca === "Tudo") {
      lista = produtos;
  } else {
      const mNorm = normalizarMarca(marca);
      lista = produtos.filter(p => normalizarMarca(p.marca) === mNorm);
  }

  if (lista.length === 0) {
    container.innerHTML = `
      <div class="produto" style="grid-column:1/-1; padding:25px;">
        <h4 style="margin-bottom:10px;">Sem produtos dessa marca</h4>
        <img src="ativo/SemEstoque.png"
             style="width:140px; height:140px; object-fit:contain; margin:auto;">
      </div>`;
    return;
  }

  // Caixa explicando a promo√ß√£o progressiva (se ativa)
  const textoPromo = montarTextoPromoProgressiva();
  if (textoPromo) {
    container.innerHTML += `
      <div class="produto promo-card" style="grid-column:1/-1; text-align:left;">
        <h4 style="margin-bottom:6px;">üéÅ Promo√ß√£o Progressiva</h4>
        <p style="font-size:13px; line-height:1.3;">
          ${textoPromo}
        </p>
      </div>`;
  }

  lista.forEach(prod => {

    const cod = String(prod.codigo).trim();
    const img = prod.imagem && prod.imagem.trim() !== ""
      ? prod.imagem
      : "https://i.imgur.com/jzjHhHG.png";

    const valorCx = Number(prod.valor) || 0;
    const promoValor = Number(prod.valor_promo) || 0;

    /* ------------------------------------------
       MONTAGEM DO TEXTO DE PRE√áO (NORMAL / PROMO)
       PROMO 1 = pre√ßo promocional por produto
       ------------------------------------------ */
    let precoTexto = "";

    if ((prod.promo === true || prod.promo === "true") && promoValor > 0) {
      // MODELO PROMO 1 ‚Äì RISCA PRE√áO ANTIGO E MOSTRA NOVO
      precoTexto = `
        <p style="margin:4px 0; color:#b30000; font-weight:bold;">
          (${cod}) ¬∑ 
          <span style="text-decoration:line-through; color:#555;">R$ ${valorCx.toFixed(2)}</span>
          ‚Üí R$ ${promoValor.toFixed(2)}
        </p>`;
    } else {
      // PRE√áO NORMAL
      precoTexto = `
        <p style="margin:4px 0; font-weight:bold;">
          (${cod}) ¬∑ Cx R$ ${valorCx.toFixed(2)}
        </p>`;
    }

    /* ------------------------------------------
       CARD DO PRODUTO
       ------------------------------------------ */
    container.innerHTML += `
      <div class="produto"
           style="position:relative; ${(prod.promo ? 'background:#fff7b1; border:2px solid #ffd900;' : '')}">

        ${prod.promo ? `
          <div style="
            position:absolute; top:6px; left:6px;
            background:#ffd900; color:#000; padding:3px 6px;
            border-radius:4px; font-size:12px; font-weight:bold;
            box-shadow:0 0 4px rgba(0,0,0,0.3);">Promo√ß√£o</div>` : ``}

        <img src="${img}">
        <h4>${prod.descricao}</h4>

        ${precoTexto}

        <div class="qtd-container">
          <button onclick="cliqueRapido('${cod}',-1,false)">-</button>
          <input id="qtd-${cod}" value="${carrinho[cod]?.qtd || 0}">
          <button onclick="cliqueRapido('${cod}',1,false)">+</button>
        </div>

      </div>`;
  });
}

/* --- PROMO√á√ïES (prod.promo === true) --- */
function mostrarPromocoes(){
  if (!produtosCarregados) {
    alert("Produtos ainda carregando, tente novamente.");
    return;
  }

  document.getElementById("tela-marcas").classList.add("hidden");
  document.getElementById("tela-carrinho").classList.add("hidden");
  document.getElementById("tela-produtos").classList.remove("hidden");
  document.getElementById("btnCarrinho").style.display = "inline-block";
  document.getElementById("btnEnviarPedido").style.display = "none";

  const container = document.getElementById("produtos-container");
  container.innerHTML = "";
  document.getElementById("titulo-marca").textContent = "Promo√ß√µes";

  const listaPromo = produtos.filter(p => p.promo === true || p.promo === "true");

  if (listaPromo.length === 0) {
    container.innerHTML = `
      <div class="produto promo-card" style="grid-column:1/-1; padding:25px;">
        <h4 style="margin-bottom:10px;">Nenhuma promo√ß√£o dispon√≠vel</h4>
        <img src="ativo/SemEstoque.png" style="width:140px; height:140px; object-fit:contain; margin:auto;">
      </div>`;
    return;
  }

  // Caixa explicando a promo√ß√£o progressiva aqui tamb√©m, se quiser
  const textoPromo = montarTextoPromoProgressiva();
  if (textoPromo) {
    container.innerHTML += `
      <div class="produto promo-card" style="grid-column:1/-1; text-align:left;">
        <h4 style="margin-bottom:6px;">üéÅ Promo√ß√£o Progressiva</h4>
        <p style="font-size:13px; line-height:1.3;">
          ${textoPromo}
        </p>
      </div>`;
  }

  listaPromo.forEach(prod => {

    const cod = String(prod.codigo).trim();
    const img = prod.imagem && prod.imagem.trim() !== "" ? prod.imagem : "https://i.imgur.com/jzjHhHG.png";

    const valorCx = Number(prod.valor) || 0;
    const promoValor = Number(prod.valor_promo) || 0;

    const precoTexto = `
      <p style="margin:4px 0; color:#b30000; font-weight:bold;">
        (${cod}) ¬∑ 
        <span style="text-decoration:line-through; color:#555;">R$ ${valorCx.toFixed(2)}</span>
        ‚Üí R$ ${promoValor.toFixed(2)}
      </p>`;

    container.innerHTML += `
      <div class="produto promo-card" style="position:relative;">

        <div style="
            position:absolute; top:6px; left:6px;
            background:#ffd900; color:#000; padding:3px 6px;
            border-radius:4px; font-size:12px; font-weight:bold;
            box-shadow:0 0 4px rgba(0,0,0,0.3);">Promo√ß√£o</div>

        <img src="${img}">
        <h4>${prod.descricao}</h4>

        ${precoTexto}

        <div class="qtd-container">
          <button onclick="cliqueRapido('${cod}', -1, false)">-</button>
          <input id="qtd-${cod}" value="${carrinho[cod]?.qtd || 0}">
          <button onclick="cliqueRapido('${cod}', 1, false)">+</button>
        </div>
      </div>`;
  });
}
function mostrarCarrinho(){
  document.getElementById("tela-marcas").classList.add("hidden");
  document.getElementById("tela-produtos").classList.add("hidden");
  document.getElementById("tela-carrinho").classList.remove("hidden");

  document.getElementById("btnCarrinho").style.display="none";
  document.getElementById("btnEnviarPedido").style.display="inline-block";

  const cont=document.getElementById("itens-carrinho");
  cont.innerHTML="";

  // Garante brinde correto antes de desenhar carrinho
  aplicarBrindeSeNecessario();

  if(Object.keys(carrinho).length===0){
    cont.innerHTML="<p>Seu carrinho est√° vazio üõí</p>";
    document.getElementById("total-carrinho").textContent="Total: R$ 0,00";
    document.getElementById("data-ultimo-pedido").textContent="";
    return;
  }

  for(const c in carrinho){
    const p=carrinho[c];
    const valorCx=Number(p.valor)||0;
    const un=Number(p.unidades)||1;

    // Card especial para BRINDE
    if (p.brinde) {
      cont.innerHTML+=`
        <div class="carrinho-item" style="border:2px dashed #ff9800;">
          <img src="${p.imagem}">
          <div style="flex:1;text-align:left;">
            <b>üéÅ Brinde: ${p.descricao}</b><br>
            <small>N√≠vel atingido: ${p.nivelBrinde || ""} caixas</small><br>
            <span>Valor: R$ 0,00</span>
          </div>

          <div class="qtd-container">
            <input id="qtd-carrinho-${p.codigo}" value="${p.qtd}" readonly>
          </div>
        </div>`;
      continue;
    }

    // Itens normais
    cont.innerHTML+=`
      <div class="carrinho-item">
        <img src="${p.imagem}">
        <div style="flex:1;text-align:left;">
          <b>${p.descricao}</b><br>
          <small>Qt Cx: ${un} ¬∑ (${p.codigo})</small><br>
          <span>Cx R$ ${valorCx.toFixed(2)}</span>
        </div>

        <div class="qtd-container">
          <button onclick="cliqueRapido('${p.codigo}',-1,true)">-</button>
          <input id="qtd-carrinho-${p.codigo}" value="${p.qtd}">
          <button onclick="cliqueRapido('${p.codigo}',1,true)">+</button>
        </div>
      </div>`;
  }

  atualizarTotal();
}

/* Altera quantidade de um c√≥digo (e j√° cuida do brinde) */
function alterarQtd(cod,delta,dentroCarrinho=false){
  const prod=produtos.find(p=>String(p.codigo).trim()===String(cod).trim());
  if(!prod) return;

  const atual=carrinho[cod]?.qtd||0;
  let nova=atual+delta;
  if(nova<0) nova=0;

  const valorCxOriginal=Number(prod.valor)||0;
  const un=Number(prod.unidades)||1;

  if(nova>0){
    carrinho[cod]={...prod,valor:valorCxOriginal,unidades:un,qtd:nova};
  }else{
    delete carrinho[cod];
  }

  const i1=document.getElementById(`qtd-${cod}`);
  const i2=document.getElementById(`qtd-carrinho-${cod}`);
  if(i1) i1.value=nova;
  if(i2) i2.value=nova;

  // Atualiza brinde progressivo conforme quantidade total
  aplicarBrindeSeNecessario();
  atualizarTotal();
}

function cliqueRapido(cod,delta,dentro){
  alterarQtd(cod,delta,dentro);
}

/* Total considera pre√ßo dos itens (brinde j√° √© 0) */
function atualizarTotal(){
  let total=0;
  for(const c in carrinho){
    total+= (Number(carrinho[c].valor)||0) * (Number(carrinho[c].qtd)||0);
  }

  document.getElementById("total").textContent="Total: R$ "+total.toFixed(2);
  const t=document.getElementById("total-carrinho");
  if(t) t.textContent="Total: R$ "+total.toFixed(2);
}
/* --- ENVIAR WHATSAPP --- */
function enviarWhatsApp(){
  if(!telefoneDigits){
    alert("Cadastre um contato primeiro.");
    abrirPopup();
    return;
  }
  if(Object.keys(carrinho).length===0){
    alert("Seu carrinho est√° vazio.");
    return;
  }

  // Garante brinde atualizado antes de enviar
  aplicarBrindeSeNecessario();

  let total=0;
  let linhas=[];

  for(const cod in carrinho){
    const p=carrinho[cod];
    const valorCx=Number(p.valor)||0;
    const un=Number(p.unidades)||1;
    const valorUn = un ? (valorCx/un) : valorCx;

    if (p.brinde) {
      // Linha especial para BRINDE
      linhas.push(
        `Brinde: ${p.descricao}\n`+
        `Qtd: ${p.qtd}\n`+
        `Valor: R$ 0,00\n`
      );
      continue;
    }

    total+=valorCx*p.qtd;

    linhas.push(
      `${p.descricao}\n`+
      `Qt Cx: ${un} . (${p.codigo})\n`+
      `UN R$ ${valorUn.toFixed(2)}  . Cx R$ ${valorCx.toFixed(2)}\n`+
      `Qtd Pedida: ${p.qtd} Cx\n`
    );
  }

  const ddd=telefoneDigits.slice(0,2);
  const resto=telefoneDigits.slice(2);

  const msg=
    `Contato: ${ddd}-${resto}\n`+
    `PEDIDO ONLINE\n\n`+
    linhas.join("\n")+
    `\nTOTAL: R$ ${total.toFixed(2)}`;

  const ultimo={
    data:new Date().toISOString(),
    itens:carrinho,
    total:total,
    telefoneDigits:telefoneDigits
  };
  localStorage.setItem(STORAGE_ULTIMO,JSON.stringify(ultimo));

  const url=`https://wa.me/55${telefoneDigits}?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
}

/* --- √öLTIMO PEDIDO (ajuste para brinde progressivo) --- */
function exibirUltimoPedido(){
  const raw=localStorage.getItem(STORAGE_ULTIMO);
  if(!raw){alert("Nenhum pedido anterior.");return;}

  try{
    const ult=JSON.parse(raw);
    if(!ult.itens){alert("Nenhum pedido anterior.");return;}

    carrinho={};
    for(const c in ult.itens){
      const p=ult.itens[c];
      carrinho[c]={...p,qtd:Number(p.qtd)||0};
    }

    // Reaplica regra de brinde baseado na quantidade atual
    aplicarBrindeSeNecessario();

    mostrarCarrinho();

    const el=document.getElementById("data-ultimo-pedido");
    if(el){
      const dt=new Date(ult.data);
      if(!isNaN(dt.getTime())){
        el.textContent="√öltimo pedido em: "+
          dt.toLocaleString("pt-BR",{
            day:"2-digit",month:"2-digit",year:"numeric",
            hour:"2-digit",minute:"numeric"
          });
      }
    }
  }catch{
    alert("Erro ao carregar √∫ltimo pedido.");
  }
}
